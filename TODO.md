# 开发任务清单 (TODO)

本文档列出了需要完成的所有开发任务，基于 PRD 文档。

---

## 🎯 当前阶段：Phase 1 - Week 1 ✅

- [x] 项目初始化
- [x] 数据库设计与模型
- [x] 基础 API 框架
- [x] 前端项目结构
- [x] Docker 配置
- [x] 文档编写
- [x] 部署方案

**状态**: ✅ **已完成**

---

## 🚧 Phase 1 - Week 2: 核心后端功能 (当前任务)

### 优先级 P0 - 代理转发

- [ ] **创建代理服务模块** (`backend/app/services/proxy.py`)
  - [ ] 实现 HTTP 代理转发逻辑
  - [ ] 支持 GET/POST/PUT/DELETE 等方法
  - [ ] 请求头处理
  - [ ] 请求体转发
  - [ ] 响应处理

- [ ] **密钥选择逻辑** (`backend/app/services/key_selector.py`)
  - [ ] 轮询算法 (Round Robin)
  - [ ] 随机选择
  - [ ] 加权选择
  - [ ] 排除禁用/封禁的密钥
  - [ ] 配额检查

- [ ] **代理路由** (`backend/app/api/proxy.py`)
  - [ ] 实现 `/proxy/:upstream_name/*` 路由
  - [ ] 集成密钥选择
  - [ ] 集成代理服务
  - [ ] 错误处理

- [ ] **超时和重试**
  - [ ] 配置超时时间
  - [ ] 实现重试逻辑
  - [ ] 指数退避

### 优先级 P0 - 规则引擎

- [ ] **规则引擎核心** (`backend/app/services/rule_engine.py`)
  - [ ] 条件解析器
    - [ ] HTTP 状态码匹配
    - [ ] 响应体文本匹配
    - [ ] JSON 路径匹配
    - [ ] 响应头匹配
    - [ ] 请求耗时判断
  - [ ] 逻辑运算符 (AND/OR)
  - [ ] 动作执行器
    - [ ] 禁用密钥
    - [ ] 封禁密钥
    - [ ] 发送告警
    - [ ] 记录日志

- [ ] **规则触发器**
  - [ ] 在代理响应后调用规则引擎
  - [ ] 记录触发的规则
  - [ ] 更新密钥状态

### 优先级 P0 - 日志记录

- [ ] **请求日志服务** (`backend/app/services/logger.py`)
  - [ ] 自动记录每个代理请求
  - [ ] 记录请求/响应详情
  - [ ] 记录触发的规则
  - [ ] 可配置是否记录 body
  - [ ] 性能优化 (异步写入)

### 优先级 P1 - 密钥管理

- [ ] **配额管理** (`backend/app/services/quota.py`)
  - [ ] 配额递增
  - [ ] 配额检查
  - [ ] 配额重置逻辑
  - [ ] 定时重置任务

- [ ] **自动恢复逻辑**
  - [ ] 定时检查禁用的密钥
  - [ ] 根据 auto_enable_at 自动启用
  - [ ] 记录恢复日志

### 优先级 P1 - 定时任务

- [ ] **任务调度器** (`backend/app/services/scheduler.py`)
  - [ ] 配额重置任务 (每日/每小时)
  - [ ] 密钥自动启用任务
  - [ ] 日志清理任务
  - [ ] 统计数据更新

---

## 📱 Phase 1 - Week 3: 核心前端功能

### 优先级 P0 - 上游 API 管理

- [ ] **上游列表页** (`frontend/src/app/upstreams/page.tsx`)
  - [ ] 表格展示
  - [ ] 搜索功能
  - [ ] 筛选 (启用/禁用)
  - [ ] 排序
  - [ ] 批量操作

- [ ] **上游创建/编辑页** (`frontend/src/app/upstreams/[id]/page.tsx`)
  - [ ] 表单组件
  - [ ] 字段验证
  - [ ] 成功/错误提示
  - [ ] 返回列表

- [ ] **上游详情页**
  - [ ] Tab: 概览
  - [ ] Tab: 关联密钥
  - [ ] Tab: 请求头配置
  - [ ] Tab: 失效规则
  - [ ] Tab: 请求日志

### 优先级 P0 - 密钥管理

- [ ] **密钥列表页** (`frontend/src/app/keys/page.tsx`)
  - [ ] 表格展示
  - [ ] 密钥值脱敏
  - [ ] 状态标识 (颜色)
  - [ ] 配额进度条
  - [ ] 筛选 (状态/上游/配额)
  - [ ] 快速操作 (启用/禁用/删除)

- [ ] **密钥创建/编辑页** (`frontend/src/app/keys/[id]/page.tsx`)
  - [ ] 完整表单
  - [ ] 密钥位置配置
  - [ ] 配额设置
  - [ ] 自动化策略

- [ ] **密钥测试功能**
  - [ ] 测试对话框
  - [ ] 发送测试请求
  - [ ] 显示响应结果
  - [ ] 验证密钥有效性

- [ ] **批量操作**
  - [ ] 批量导入 (CSV/JSON)
  - [ ] 批量导出
  - [ ] 批量启用/禁用
  - [ ] 批量删除

### 优先级 P0 - 仪表板

- [ ] **仪表板主页** (`frontend/src/app/dashboard/page.tsx`)
  - [ ] 关键指标卡片
    - [ ] 今日请求数
    - [ ] 成功率
    - [ ] 活跃密钥数
    - [ ] 平均响应时间
  - [ ] 实时请求流 (最近50条)
  - [ ] 状态码分布图 (饼图)
  - [ ] 密钥健康状态
  - [ ] 快速操作入口

- [ ] **图表组件**
  - [ ] 使用 Recharts
  - [ ] 响应式设计
  - [ ] 数据刷新

### 优先级 P1 - 请求头配置

- [ ] **请求头列表** (`frontend/src/app/headers/page.tsx`)
  - [ ] 表格展示
  - [ ] 按上游筛选
  - [ ] 拖拽排序

- [ ] **请求头编辑**
  - [ ] 静态值输入
  - [ ] 脚本编辑器 (Monaco Editor)
  - [ ] 脚本测试
  - [ ] 模板选择

---

## 🎨 Phase 1 - Week 4: 规则与完善

### 优先级 P0 - 失效规则

- [ ] **规则列表页** (`frontend/src/app/rules/page.tsx`)
  - [ ] 表格展示
  - [ ] 规则预览
  - [ ] 启用/禁用切换

- [ ] **规则创建/编辑页** (`frontend/src/app/rules/[id]/page.tsx`)
  - [ ] 可视化规则构建器
  - [ ] 条件编辑器
  - [ ] 多条件组合 (AND/OR)
  - [ ] 动作选择
  - [ ] 高级选项

- [ ] **规则测试工具**
  - [ ] 模拟响应输入
  - [ ] 显示匹配结果
  - [ ] 预览执行动作

### 优先级 P1 - 请求日志

- [ ] **日志列表页** (`frontend/src/app/logs/page.tsx`)
  - [ ] 表格展示
  - [ ] 时间范围筛选
  - [ ] 状态码筛选
  - [ ] 上游/密钥筛选
  - [ ] 导出功能

- [ ] **日志详情页** (`frontend/src/app/logs/[id]/page.tsx`)
  - [ ] 请求信息
  - [ ] 响应信息
  - [ ] 格式化 JSON
  - [ ] 复制为 cURL
  - [ ] 重放请求

- [ ] **日志统计页**
  - [ ] 请求量趋势图
  - [ ] 状态码分布
  - [ ] 耗时分布
  - [ ] Top 10 慢请求
  - [ ] Top 10 错误

### 优先级 P1 - 系统设置

- [ ] **系统设置页** (`frontend/src/app/settings/page.tsx`)
  - [ ] 通用设置
  - [ ] 日志保留配置
  - [ ] 性能设置

### 优先级 P1 - 测试与优化

- [ ] **集成测试**
  - [ ] 端到端测试
  - [ ] API 测试
  - [ ] 前端测试

- [ ] **Bug 修复**
  - [ ] 修复已知问题
  - [ ] 性能优化
  - [ ] UI/UX 改进

---

## 🚀 Phase 2: 增强功能 (Week 5-6)

### Week 5: 高级功能

- [ ] **JavaScript 脚本执行**
  - [ ] 集成 py-mini-racer
  - [ ] 沙箱环境
  - [ ] 超时控制
  - [ ] 错误处理

- [ ] **频率限制**
  - [ ] 限制规则配置
  - [ ] 计数器实现 (Redis)
  - [ ] 超限处理

- [ ] **通知系统**
  - [ ] 邮件通知
  - [ ] Webhook
  - [ ] 企业微信/钉钉集成

### Week 6: 用户体验优化

- [ ] **图表优化**
  - [ ] 更多图表类型
  - [ ] 实时更新
  - [ ] 交互优化

- [ ] **批量操作完善**
  - [ ] CSV 导入优化
  - [ ] 字段映射配置
  - [ ] 错误提示

- [ ] **性能优化**
  - [ ] 前端代码分割
  - [ ] 懒加载
  - [ ] 缓存策略
  - [ ] 压测

---

## 🎓 Phase 3: 企业特性 (Week 7-8)

### Week 7: 高级特性

- [ ] **Python 脚本执行**
  - [ ] RestrictedPython
  - [ ] 安全限制

- [ ] **用户权限系统**
  - [ ] 用户管理
  - [ ] 角色管理
  - [ ] 权限控制
  - [ ] JWT 认证

- [ ] **操作审计**
  - [ ] 记录所有操作
  - [ ] 审计日志查询
  - [ ] 审计报告

### Week 8: 部署与文档

- [ ] **生产部署**
  - [ ] PostgreSQL 迁移
  - [ ] Redis 集成
  - [ ] 负载均衡
  - [ ] 监控告警

- [ ] **文档完善**
  - [ ] 用户手册
  - [ ] API 文档更新
  - [ ] 最佳实践
  - [ ] FAQ

- [ ] **备份与恢复**
  - [ ] 数据备份方案
  - [ ] 自动备份脚本
  - [ ] 恢复测试

---

## 📊 任务统计

| 阶段 | 总任务 | 已完成 | 进行中 | 未开始 | 完成率 |
|------|--------|--------|--------|--------|--------|
| Week 1 | 10 | 10 | 0 | 0 | 100% ✅ |
| Week 2 | 20 | 0 | 0 | 20 | 0% |
| Week 3 | 25 | 0 | 0 | 25 | 0% |
| Week 4 | 18 | 0 | 0 | 18 | 0% |
| Phase 2 | 15 | 0 | 0 | 15 | 0% |
| Phase 3 | 12 | 0 | 0 | 12 | 0% |
| **总计** | **100** | **10** | **0** | **90** | **10%** |

---

## 🔥 下一步应该做什么？

### 立即开始 (最高优先级)

1. **代理转发功能** - 这是系统的核心
   - 创建 `backend/app/services/proxy.py`
   - 实现基本的 HTTP 代理
   - 添加 `/proxy/*` 路由

2. **密钥选择器** - 密钥轮询逻辑
   - 创建 `backend/app/services/key_selector.py`
   - 实现轮询算法

3. **基础规则引擎** - 失效检测
   - 创建 `backend/app/services/rule_engine.py`
   - 实现状态码检测

4. **前端仪表板** - 用户界面
   - 创建仪表板页面
   - 展示关键指标

### 推荐开发顺序

```
Week 2 后端核心功能
  ↓
Week 3 前端基础界面
  ↓
Week 4 规则引擎完善
  ↓
测试和优化
  ↓
Phase 2/3 高级功能
```

---

## 📝 贡献指南

完成任务后:
1. 在任务前标记 `[x]`
2. 提交代码到 git
3. 更新 CHANGELOG.md
4. 如有需要，更新文档

---

**最后更新**: 2025-11-02
**当前进度**: Phase 1 - Week 1 完成 ✅
**下一目标**: Phase 1 - Week 2 核心后端功能
