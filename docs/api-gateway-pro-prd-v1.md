# API 透传系统 PRD 文档

## 文档信息
- **产品名称**：API Gateway Pro（API 透传管理系统）
- **文档版本**：v1.0
- **编写日期**：2025-11-02
- **产品经理**：待定
- **目标上线**：待定

---

## 一、产品概述

### 1.1 产品定位
API Gateway Pro 是一个智能化的 API 代理与密钥管理系统，为开发者和企业提供统一的 API 调用管理平台，通过智能密钥轮询、自动故障检测、动态参数生成等功能，提升 API 调用的稳定性和可管理性。

### 1.2 目标用户
- **主要用户**：需要管理多个 API 密钥的开发者
- **次要用户**：需要代理第三方 API 的企业团队
- **典型场景**：
  - OpenAI API 密钥池管理
  - 第三方服务 API 聚合调用
  - API 成本优化与监控

### 1.3 核心价值
- 🔑 **密钥池管理**：统一管理多个 API 密钥，自动轮询和故障切换
- 🛡️ **智能防护**：自动识别密钥失效、配额用尽、被封禁等异常
- ⚙️ **灵活配置**：支持自定义请求头、脚本化参数生成
- 📊 **可观测性**：实时监控 API 调用状态、统计分析
- 🔄 **自动化运维**：密钥自动禁用/启用、配额重置

---

## 二、功能需求

### 2.1 功能架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Web 管理界面 (Next.js)                │
├─────────────────────────────────────────────────────────┤
│  仪表板  │  上游API  │  密钥管理  │  规则配置  │  日志  │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   后端服务 (FastAPI)                     │
├──────────────┬──────────────┬──────────────┬───────────┤
│  代理转发    │  规则引擎    │  脚本执行    │  定时任务  │
└─────────────────────────────────────────────────────────┘
                            ▼
                    ┌───────────────┐
                    │  SQLite 数据库 │
                    └───────────────┘
```

### 2.2 核心功能模块

#### 模块 1：仪表板（Dashboard）

**功能说明**：系统总览与关键指标展示

**功能点**：
1. **关键指标卡片**
   - 总请求数（今日/本周/本月）
   - 成功率（百分比 + 趋势图）
   - 活跃密钥数 / 总密钥数
   - 平均响应时间

2. **实时请求流**
   - 最近 50 条请求记录
   - 实时状态码分布
   - 错误率实时图表

3. **密钥健康状态**
   - 密钥状态分布（饼图）
   - 即将达到配额的密钥预警
   - 失效密钥列表

4. **快速操作入口**
   - 新增上游 API
   - 添加密钥
   - 查看错误日志

**UI 交互**：
- 响应式布局，适配桌面和平板
- 卡片式设计，支持拖拽排序（Phase 2）
- 自动刷新（可配置间隔：5s/10s/30s/关闭）

---

#### 模块 2：上游 API 管理

**功能说明**：配置需要代理的目标 API 服务

**功能点**：

1. **API 列表页**
   - 表格展示：名称、Base URL、密钥数量、状态、操作
   - 搜索：按名称、URL 搜索
   - 筛选：按状态（启用/禁用）
   - 排序：按创建时间、名称
   - 批量操作：启用/禁用、删除

2. **新增/编辑 API**
   - **基础信息**
     - API 名称（必填）
     - Base URL（必填，验证 URL 格式）
     - 描述（选填，富文本）
     - 状态（启用/禁用）
   
   - **代理配置**
     - 代理路径前缀（如：`/v1/openai`）
     - 超时时间（秒，默认 30）
     - 重试次数（0-5，默认 1）
     - 连接池大小（默认 10）
   
   - **高级选项**
     - 是否记录请求体（影响性能）
     - 是否记录响应体（影响性能）
     - 自定义标签（用于分类）

3. **API 详情页**
   - Tab 1: 概览（统计数据）
   - Tab 2: 密钥列表（关联的密钥）
   - Tab 3: 请求头配置
   - Tab 4: 失效规则
   - Tab 5: 频率限制
   - Tab 6: 请求日志

**交互细节**：
- 新增时支持从模板创建（预设 OpenAI、Claude 等常见 API）
- 编辑时显示最后修改时间和操作人
- 删除需二次确认，提示关联的密钥数量
- Base URL 输入时自动检测连通性（可选）

---

#### 模块 3：密钥管理

**功能说明**：管理 API 密钥的生命周期

**功能点**：

1. **密钥列表页**
   - **表格字段**
     - 密钥名称/备注
     - 密钥值（脱敏显示：`sk-***abc`）
     - 所属 API
     - 状态（活跃/禁用/封禁）
     - 配额使用（进度条：已用/总额）
     - 最后使用时间
     - 操作（编辑/禁用/删除/测试）
   
   - **筛选条件**
     - 按上游 API 筛选
     - 按状态筛选
     - 按配额使用率筛选（<50%, 50-80%, >80%）
   
   - **批量操作**
     - 批量启用/禁用
     - 批量导入（CSV/JSON）
     - 批量导出
     - 批量删除

2. **新增/编辑密钥**
   - **基础信息**
     - 所属上游 API（下拉选择）
     - 密钥值（必填，文本框）
     - 密钥名称/备注（选填）
   
   - **密钥位置配置**
     - 位置类型（单选）：
       - ✓ HTTP Header
       - ✓ Query Parameter
       - ✓ Request Body
     - 参数名称（如：`Authorization`、`api_key`）
     - 值前缀（如：`Bearer `、`sk-`）
   
   - **配额管理**
     - 是否启用配额限制（开关）
     - 配额总额（数字输入，可选单位：次/天、次/月）
     - 配额重置策略：
       - 每日零点重置
       - 固定时间间隔（小时）
       - 手动重置
   
   - **自动化策略**
     - 失效后自动禁用（开关）
     - 自动启用延迟（选填，单位：小时）
       - 示例：配额用尽后 24 小时自动启用
     - 封禁后处理：
       - 永久禁用
       - 人工审核后启用

3. **密钥测试功能**
   - 点击「测试」按钮后弹窗
   - 显示测试请求的构造信息
   - 发送测试请求到真实 API
   - 展示响应结果（状态码、耗时、body）
   - 根据失效规则自动判断密钥是否有效

4. **密钥详情页**
   - 使用统计（折线图：近 7 天请求量）
   - 配额使用趋势
   - 成功率统计
   - 最近请求记录（Top 20）
   - 错误日志（如果有）

**交互细节**：
- 密钥值支持显示/隐藏切换
- 配额使用超过 80% 显示警告色
- 禁用状态显示倒计时（距离自动启用还有 X 小时）
- 支持快速复制密钥值
- 导入时支持字段映射配置

---

#### 模块 4：请求头配置

**功能说明**：为上游 API 配置自定义请求头

**功能点**：

1. **请求头列表**（在上游 API 详情页内）
   - 表格展示：
     - Header 名称
     - 值类型（静态/JS 脚本/Python 脚本）
     - Header 值（静态）或脚本预览
     - 优先级（数字，影响执行顺序）
     - 启用状态
     - 操作（编辑/删除/测试）
   
   - 支持拖拽排序

2. **新增/编辑请求头**
   - **基础配置**
     - Header 名称（下拉 + 自定义）
       - 常见选项：`User-Agent`、`Referer`、`X-Custom-Id` 等
     - 值类型（单选）：
       - **静态值**：直接输入文本
       - **JavaScript 脚本**：动态生成
       - **Python 脚本**：动态生成
   
   - **静态值模式**
     - 文本输入框
     - 支持变量占位符：`{{timestamp}}`、`{{random}}`、`{{uuid}}`
   
   - **脚本模式**
     - 代码编辑器（语法高亮、自动补全）
     - 可用上下文变量：
       ```javascript
       // JavaScript 示例
       {
         request: { method, path, query, body, headers },
         timestamp: 1699999999,
         apiKey: "sk-***",
         random: Math.random
       }
       ```
     
     - 脚本模板库：
       - 生成签名（MD5、SHA256）
       - 生成时间戳 + 随机数
       - 请求体加密
   
   - **高级选项**
     - 执行超时（默认 1 秒）
     - 失败时的降级策略：
       - 使用默认值
       - 跳过该 Header
       - 终止请求

3. **脚本测试工具**
   - 模拟请求数据输入
   - 执行脚本
   - 查看生成的 Header 值
   - 查看执行日志（console.log 输出）

**交互细节**：
- 代码编辑器使用 Monaco Editor（VS Code 同款）
- 脚本编辑时自动保存草稿
- 支持从模板库选择常用脚本
- 优先级用拖拽条或数字输入
- 测试成功后显示生成结果的预览

**安全考虑**：
- 脚本执行在沙箱环境中
- 限制可访问的 API（禁止文件系统、网络访问）
- 限制执行时间和内存使用

---

#### 模块 5：失效规则配置

**功能说明**：定义密钥失效的判断条件

**功能点**：

1. **规则列表**（在上游 API 详情页内）
   - 表格展示：
     - 规则名称
     - 触发条件（简化描述）
     - 触发动作（禁用/封禁/告警）
     - 逻辑关系（与其他规则的 AND/OR）
     - 优先级
     - 启用状态
     - 操作（编辑/删除/测试）

2. **新增/编辑规则**
   - **基础信息**
     - 规则名称（必填）
     - 规则描述（选填）
     - 启用状态
   
   - **触发条件**（支持多条件组合）
     - 条件类型（下拉）：
       - **HTTP 状态码**
         - 操作符：等于、不等于、大于、小于、在范围内
         - 值：200、401、403、429、500 等
       
       - **响应体包含**
         - 操作符：包含、不包含、正则匹配
         - 值：文本内容（如 "quota exceeded"）
       
       - **JSON 路径匹配**
         - JSON Path：`error.code`、`data.status`
         - 操作符：等于、不等于、存在、为空
         - 值：预期值
       
       - **响应头匹配**
         - Header 名称：`X-RateLimit-Remaining`
         - 操作符：等于、小于等
         - 值：0
       
       - **请求耗时**
         - 操作符：大于、小于
         - 值：毫秒数
   
   - **多条件逻辑**
     - 条件之间的关系（可视化拖拽构建）：
       ```
       (条件1 AND 条件2) OR 条件3
       ```
     - 支持括号分组
     - 实时显示逻辑表达式
   
   - **触发动作**
     - 动作类型（多选）：
       - **禁用密钥**
         - 自动启用延迟（小时）
       - **封禁密钥**（永久禁用）
       - **发送告警**
         - 告警方式：邮件/Webhook/企业微信/钉钉
       - **记录日志**（默认）
   
   - **高级选项**
     - 触发次数阈值（连续 N 次才触发）
     - 时间窗口（N 秒内）
     - 冷却时间（触发后 N 秒内不再触发）

3. **规则测试工具**
   - 输入模拟响应数据
   - 显示哪些规则会被触发
   - 显示最终会执行的动作

**交互细节**：
- 可视化规则构建器（类似 SQL 查询构建器）
- 支持从常见场景选择模板：
  - OpenAI 配额用尽检测
  - 密钥无效检测
  - 频率限制检测
- 规则优先级通过拖拽排序
- 条件编辑时实时验证语法

---

#### 模块 6：频率限制配置

**功能说明**：防止密钥被滥用，限制调用频率

**功能点**：

1. **限制规则列表**
   - 表格展示：
     - 规则名称
     - 时间窗口（秒/分钟/小时）
     - 最大请求数
     - 触发动作
     - 启用状态

2. **新增/编辑规则**
   - 时间窗口（数字 + 单位）：
     - 秒、分钟、小时、天
   - 最大请求数
   - 限制范围：
     - 单个密钥
     - 整个 API
     - 全局
   - 触发动作：
     - 禁用密钥
     - 拒绝请求（返回 429）
     - 降级处理（排队）

**交互细节**：
- 可视化展示当前速率（如：10 req/min）
- 支持临时调整额度

---

#### 模块 7：请求日志

**功能说明**：查看和分析所有代理请求记录

**功能点**：

1. **日志列表页**
   - **表格字段**
     - 时间（精确到毫秒）
     - 上游 API
     - 使用的密钥（脱敏）
     - 请求方法 + 路径
     - 状态码（颜色标识：绿/黄/红）
     - 耗时（毫秒）
     - 操作（查看详情）
   
   - **筛选条件**
     - 时间范围（快捷选择：今天/昨天/近 7 天/自定义）
     - 上游 API
     - 密钥
     - 状态码范围
     - 耗时范围
   
   - **搜索**
     - 按请求路径搜索
     - 按错误信息搜索
   
   - **导出**
     - 导出为 CSV/JSON
     - 支持自定义导出字段

2. **日志详情页**
   - **请求信息**
     - 请求方法、完整 URL
     - 请求头（可折叠）
     - 请求体（格式化显示 JSON）
   
   - **响应信息**
     - 状态码、耗时
     - 响应头（可折叠）
     - 响应体（格式化显示、支持搜索）
   
   - **元数据**
     - 使用的密钥 ID
     - 客户端 IP
     - 触发的规则（如果有）
     - 错误信息（如果有）
   
   - **快捷操作**
     - 复制为 cURL 命令
     - 重放请求
     - 标记为错误/正常

3. **日志统计**
   - 请求量趋势图（可按小时/天/周聚合）
   - 状态码分布（饼图）
   - 耗时分布（直方图）
   - Top 10 慢请求
   - Top 10 错误路径

**交互细节**：
- 实时日志流（WebSocket 推送最新日志）
- 日志列表虚拟滚动（支持大量数据）
- 错误日志高亮显示
- 支持展开/收起查看完整内容

---

#### 模块 8：系统设置

**功能说明**：全局配置和系统管理

**功能点**：

1. **通用设置**
   - 系统名称
   - 时区配置
   - 语言（中文/英文）
   - 日志保留天数（默认 30 天）
   - 自动清理策略

2. **安全设置**
   - 访问控制：
     - 启用认证（开关）
     - 管理员密码修改
     - API Token 管理
   - IP 白名单
   - 密钥加密存储（开关）

3. **通知设置**
   - 邮件配置（SMTP）
   - Webhook URL
   - 企业微信/钉钉机器人配置
   - 通知场景配置：
     - 密钥失效通知
     - 配额预警通知
     - 系统异常通知

4. **性能设置**
   - 并发连接数限制
   - 请求队列大小
   - 缓存策略
   - 日志采样率（高负载时降低日志记录）

5. **备份与恢复**
   - 数据库备份（手动/定时）
   - 配置导出/导入
   - 恢复数据

**交互细节**：
- 修改关键配置需要二次确认
- 配置变更后显示「重启生效」提示
- 测试配置（如测试邮件发送）

---

#### 模块 9：用户与权限（Phase 2）

**功能说明**：多用户协作与权限管理

**功能点**：
1. 用户管理（管理员/普通用户/只读用户）
2. 角色权限配置
3. 操作审计日志
4. API Token 管理（用于 API 调用管理接口）

---

### 2.3 功能优先级

| 优先级 | 功能模块 | 说明 |
|--------|----------|------|
| P0 | 上游 API 管理、密钥管理、代理转发 | 核心功能，MVP 必需 |
| P0 | 失效规则配置、请求头配置 | 差异化功能，MVP 必需 |
| P1 | 仪表板、请求日志 | 提升用户体验 |
| P1 | 频率限制、自动恢复 | 运维自动化 |
| P2 | 脚本执行（Python）、高级统计 | 增强功能 |
| P3 | 用户权限、审计日志 | 企业级功能 |

---

## 三、非功能需求

### 3.1 性能要求
- **响应时间**：
  - 代理请求延迟 < 50ms（P95）
  - 管理界面接口响应 < 200ms
- **并发能力**：
  - 支持 1000 QPS（单机）
  - 支持 10 万+ 密钥规模
- **可用性**：
  - 系统可用性 ≥ 99.9%
  - 支持热重启（配置变更不中断服务）

### 3.2 安全要求
- **数据安全**：
  - 密钥值加密存储（AES-256）
  - 日志脱敏处理
  - 支持 HTTPS
- **访问控制**：
  - 管理界面 JWT 认证
  - API Token 鉴权
  - 操作审计
- **脚本安全**：
  - 沙箱执行环境
  - 资源限制（CPU、内存、执行时间）

### 3.3 可扩展性
- 数据库可切换（SQLite → PostgreSQL/MySQL）
- 支持分布式部署（Redis 共享状态）
- 插件化架构（自定义规则引擎、中间件）

### 3.4 易用性
- **学习成本**：新用户 10 分钟内完成首次配置
- **文档**：提供快速开始指南、API 文档、FAQ
- **反馈**：操作成功/失败有明确提示
- **兼容性**：支持主流浏览器（Chrome、Firefox、Safari、Edge）

---

## 四、技术架构

### 4.1 技术栈

**前端**：
- **框架**：Next.js 14 (App Router)
- **UI 库**：Tailwind CSS + shadcn/ui
- **状态管理**：Zustand / React Context
- **图表库**：Recharts / Apache ECharts
- **代码编辑器**：Monaco Editor
- **请求库**：Axios / SWR
- **表单验证**：React Hook Form + Zod

**后端**：
- **框架**：FastAPI (Python 3.10+)
- **数据库**：SQLite (开发) / PostgreSQL (生产)
- **ORM**：SQLAlchemy 2.0
- **异步**：asyncio + httpx
- **定时任务**：APScheduler
- **脚本执行**：
  - JavaScript: py-mini-racer
  - Python: RestrictedPython / subprocess
- **日志**：structlog

**部署**：
- **容器化**：Docker + Docker Compose
- **反向代理**：Nginx / Caddy
- **进程管理**：systemd / PM2

### 4.2 系统架构图

```
┌──────────────────────────────────────────────────────────────┐
│                        用户浏览器                             │
│              (Next.js 前端 - Port 3000)                      │
└───────────────────────────┬──────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│                     Nginx/Caddy                               │
│           (反向代理 + HTTPS + 静态文件)                       │
└───────┬──────────────────────────────────┬───────────────────┘
        │                                  │
        ▼                                  ▼
┌───────────────────┐            ┌─────────────────────────────┐
│  管理 API         │            │  代理 API                    │
│  /api/admin/*     │            │  /proxy/*                   │
│  (FastAPI)        │            │  (FastAPI)                  │
└────────┬──────────┘            └──────────┬──────────────────┘
         │                                   │
         ▼                                   ▼
┌──────────────────────────────────────────────────────────────┐
│                      业务逻辑层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐    │
│  │ 密钥管理     │  │ 规则引擎     │  │ 脚本执行器         │    │
│  └─────────────┘  └─────────────┘  └───────────────────┘    │
│  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐    │
│  │ 请求转发     │  │ 日志记录     │  │ 定时任务调度       │    │
│  └─────────────┘  └─────────────┘  └───────────────────┘    │
└────────┬─────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│                    数据持久化层                               │
│         SQLite / PostgreSQL + Redis (Cache)                  │
└──────────────────────────────────────────────────────────────┘
```

### 4.3 数据库设计（核心表）

详见第二章节"数据库设计"部分（已在之前的规划中提供）

### 4.4 API 设计

**RESTful API 规范**：

```
# 上游 API 管理
GET    /api/admin/upstreams          # 列表
POST   /api/admin/upstreams          # 创建
GET    /api/admin/upstreams/:id      # 详情
PUT    /api/admin/upstreams/:id      # 更新
DELETE /api/admin/upstreams/:id      # 删除

# 密钥管理
GET    /api/admin/keys               # 列表
POST   /api/admin/keys               # 创建
PUT    /api/admin/keys/:id           # 更新
DELETE /api/admin/keys/:id           # 删除
POST   /api/admin/keys/:id/test      # 测试
POST   /api/admin/keys/:id/enable    # 启用
POST   /api/admin/keys/:id/disable   # 禁用
POST   /api/admin/keys/import        # 批量导入

# 请求头配置
GET    /api/admin/headers            # 列表
POST   /api/admin/headers            # 创建
PUT    /api/admin/headers/:id        # 更新
DELETE /api/admin/headers/:id        # 删除
POST   /api/admin/headers/:id/test   # 测试脚本

# 规则配置
GET    /api/admin/rules              # 列表
POST   /api/admin/rules              # 创建
PUT    /api/admin/rules/:id          # 更新
DELETE /api/admin/rules/:id          # 删除

# 日志查询
GET    /api/admin/logs               # 日志列表
GET    /api/admin/logs/:id           # 日志详情
GET    /api/admin/logs/stats         # 统计数据

# 仪表板
GET    /api/admin/dashboard/stats    # 关键指标
GET    /api/admin/dashboard/realtime # 实时数据

# 代理请求（核心功能）
ALL    /proxy/:upstream_name/*       # 代理转发
```

---

## 五、用户界 面设计

### 5.1 设计原则

1. **简洁高效**：减少操作步骤，核心功能不超过 3 次点击
2. **一致性**：统一的颜色、字体、图标、交互模式
3. **响应式**：适配桌面（1920x1080）、平板（1024x768）
4. **反馈明确**：操作结果即时反馈（Toast 提示、加载状态）
5. **容错性**：输入验证、错误提示、撤销操作

### 5.2 色彩系统

```css
/* 主色调 */
--primary: #3b82f6      /* 蓝色 - 主要操作 */
--primary-dark: #2563eb
--primary-light: #93c5fd

/* 语义色 */
--success: #10b981      /* 绿色 - 成功状态 */
--warning: #f59e0b      /* 橙色 - 警告 */
--error: #ef4444        /* 红色 - 错误/危险 */
--info: #06b6d4         /* 青色 - 信息提示 */

/* 中性色 */
--background: #ffffff
--background-secondary: #f9fafb
--border: #e5e7eb
--text-primary: #111827
--text-secondary: #6b7280
--text-disabled: #9ca3af

/* 暗色模式（可选） */
--dark-background: #1f2937
--dark-surface: #111827
```

### 5.3 布局结构

#### 整体布局

```
┌────────────────────────────────────────────────────────┐
│  Header (固定)                                          │
│  Logo | 系统名称        [搜索框]      通知 | 用户头像    │
├────┬──────────────────────────────────────────────────┤
│    │                                                   │
│ S  │              Content Area                         │
│ i  │                                                   │
│ d  │         (根据路由动态渲染页面)                     │
│ e  │                                                   │
│ b  │                                                   │
│ a  │                                                   │
│ r  │                                                   │
│    │                                                   │
│ 可 │                                                   │
│ 折 │                                                   │
│ 叠 │                                                   │
│    │                                                   │
└────┴──────────────────────────────────────────────────┘
```

#### 侧边栏菜单

```
📊 仪表板
🌐 上游 API
🔑 密钥管理
📝 请求头配置
⚙️ 规则配置
   ├─ 失效规则
   └─ 频率限制
📋 请求日志
🔧 系统设置
```

### 5.4 关键页面原型

#### 5.4.1 仪表板页面

**布局**：
```
┌─────────────────────────────────────────────────────────────┐
│  仪表板                               [刷新] [自动刷新: 10s]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 今日请求  │  │ 成功率    │  │ 活跃密钥  │  │ 平均耗时  │   │
│  │ 12,345   │  │ 98.7%    │  │ 23/45    │  │ 142ms    │   │
│  │ ↑ 12%   │  │ ↑ 0.3%   │  │          │  │ ↓ 8ms    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                                                              │
│  ┌────────────────────────────┐  ┌──────────────────────┐  │
│  │ 请求量趋势 (近 24 小时)     │  │ 状态码分布            │  │
│  │                            │  │                      │  │
│  │   [折线图]                 │  │   [饼图]             │  │
│  │                            │  │   200: 85%          │  │
│  │                            │  │   429: 10%          │  │
│  └────────────────────────────┘  │   500: 5%           │  │
│                                   └──────────────────────┘  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 实时请求流                            [暂停] [清空]     │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ 14:23:45 | POST /v1/chat | 200 | 234ms | sk-***abc  │ │
│  │ 14:23:44 | POST /v1/chat | 200 | 189ms | sk-***xyz  │ │
│  │ 14:23:43 | POST /v1/chat | 429 | 56ms  | sk-***def  │ │
│  │ ...                                                    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 密钥健康状态                                            │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ ⚠️ sk-***abc | OpenAI | 配额 95% | [查看]              │ │
│  │ 🔴 sk-***def | OpenAI | 已禁用 (2h 后自动启用) | [启用] │ │
│  │ ✅ 其他 21 个密钥运行正常                               │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 5.4.2 密钥列表页面

**布局**：
```
┌─────────────────────────────────────────────────────────────┐
│  密钥管理                                                     │
├─────────────────────────────────────────────────────────────┤
│  [+ 新增密钥]  [批量导入]  [导出]                            │
│                                                              │
│  筛选: [上游API ▼] [状态 ▼] [配额 ▼]   搜索: [_________] 🔍 │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ □ | 名称/密钥值 | 所属API | 状态 | 配额 | 最后使用 | 操作 ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ □ | OpenAI主账号 | OpenAI | ✅ | ▓▓▓░░ 76% | 2分钟前 |  ││
│  │   | sk-***abc    |        |    | 7600/10000  |        |  ││
│  │   |              |        |    |             |  [编辑]  ││
│  │   |              |        |    |             |  [禁用]  ││
│  │   |              |        |    |             |  [测试]  ││
│  │   |              |        |    |             |  [删除]  ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ □ | OpenAI备用   | OpenAI | 🔴 | ▓▓▓▓▓ 100% | 1小时前 | ││
│  │   | sk-***def    |        | 禁用| 10000/10000|         | ││
│  │   |              |        |    | 23h后自动启用|  [启用] ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ □ | Claude主账号 | Claude | ✅ | 无限制      | 刚刚    | ││
│  │   | sk-***xyz    |        |    |             |         | ││
│  └─────────────────────────────────────────────────────────┘│
│                                                              │
│  显示 1-20 / 共 45 条   [1] 2 3 ... 下一页                  │
└─────────────────────────────────────────────────────────────┘
```

#### 5.4.3 新增/编辑密钥弹窗

**布局**：
```
┌──────────────────────────────────────────┐
│  新增密钥                        [X]      │
├──────────────────────────────────────────┤
│                                          │
│  基础信息                                │
│  ┌────────────────────────────────────┐ │
│  │ 所属上游API *                      │ │
│  │ [选择 OpenAI ▼]                    │ │
│  │                                    │ │
│  │ 密钥值 *                           │ │
│  │ [sk-proj-xxxxx____________] [👁] │ │
│  │                                    │ │
│  │ 密钥名称/备注                       │ │
│  │ [主账号-高优先级_________]          │ │
│  └────────────────────────────────────┘ │
│                                          │
│  密钥位置配置                            │
│  ┌────────────────────────────────────┐ │
│  │ 位置类型 * ◉ Header ◯ Query ◯ Body│ │
│  │                                    │ │
│  │ 参数名称 *                         │ │
│  │ [Authorization_____]               │ │
│  │                                    │ │
│  │ 值前缀 (可选)                       │ │
│  │ [Bearer ____]                      │ │
│  └────────────────────────────────────┘ │
│                                          │
│  配额管理                                │
│  ┌────────────────────────────────────┐ │
│  │ ☑ 启用配额限制                      │ │
│  │                                    │ │
│  │ 配额总额   [10000__] 次/天         │ │
│  │                                    │ │
│  │ 重置策略   ◉ 每日零点               │ │
│  │           ◯ 固定间隔 [24] 小时     │ │
│  │           ◯ 手动重置                │ │
│  └────────────────────────────────────┘ │
│                                          │
│  自动化策略                              │
│  ┌────────────────────────────────────┐ │
│  │ ☑ 失效后自动禁用                    │ │
│  │ ☑ 自动启用  延迟 [24] 小时          │ │
│  └────────────────────────────────────┘ │
│                                          │
│              [取消]  [保存并测试]  [保存]│
└──────────────────────────────────────────┘
```

#### 5.4.4 规则配置页面

**布局**：
```
┌─────────────────────────────────────────────────────────────┐
│  失效规则配置 - OpenAI API                                   │
├─────────────────────────────────────────────────────────────┤
│  [+ 新增规则]  [从模板创建 ▼]                                │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ ✅ 规则 1: 配额用尽检测                    [编辑] [删除]  ││
│  │ 触发条件: (状态码 = 429) OR (Body 包含 "quota")          ││
│  │ 触发动作: 禁用密钥 (24小时后自动启用)                     ││
│  │ 优先级: 1                                                ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ ✅ 规则 2: 无效密钥检测                    [编辑] [删除]  ││
│  │ 触发条件: 状态码 = 401                                   ││
│  │ 触发动作: 封禁密钥 + 发送告警                            ││
│  │ 优先级: 2                                                ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ ⚫ 规则 3: 慢请求检测 (已禁用)             [编辑] [删除]  ││
│  │ 触发条件: 请求耗时 > 5000ms                              ││
│  │ 触发动作: 记录日志                                       ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

#### 5.4.5 规则编辑器

**布局**（可视化条件构建器）：
```
┌──────────────────────────────────────────────┐
│  编辑规则: 配额用尽检测              [X]      │
├──────────────────────────────────────────────┤
│                                              │
│  规则名称 *                                  │
│  [配额用尽检测________________]               │
│                                              │
│  触发条件 (拖拽构建逻辑表达式)                │
│  ┌────────────────────────────────────────┐ │
│  │  ┌─────────────────────────────┐       │ │
│  │  │ 条件 1                  [X] │       │ │
│  │  │ 类型: [HTTP状态码 ▼]        │       │ │
│  │  │ 操作: [等于 ▼]  值: [429]   │       │ │
│  │  └─────────────────────────────┘       │ │
│  │              [OR ▼]                    │ │
│  │  ┌─────────────────────────────┐       │ │
│  │  │ 条件 2                  [X] │       │ │
│  │  │ 类型: [响应体包含 ▼]        │       │ │
│  │  │ 操作: [包含 ▼]              │       │ │
│  │  │ 值: [quota exceeded____]    │       │ │
│  │  └─────────────────────────────┘       │ │
│  │                                        │ │
│  │          [+ 添加条件]                  │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  逻辑表达式预览:                             │
│  (状态码 = 429) OR (Body 包含 "quota")       │
│                                              │
│  触发动作                                    │
│  ┌────────────────────────────────────────┐ │
│  │ ☑ 禁用密钥                             │ │
│  │   自动启用延迟: [24] 小时              │ │
│  │                                        │ │
│  │ ☐ 封禁密钥 (永久禁用)                  │ │
│  │                                        │ │
│  │ ☑ 发送告警                             │ │
│  │   方式: [邮件 ▼]                       │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  高级选项                                    │
│  ┌────────────────────────────────────────┐ │
│  │ 触发阈值: 连续 [3] 次                  │ │
│  │ 时间窗口: [60] 秒                      │ │
│  │ 冷却时间: [300] 秒                     │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  [测试规则]            [取消]  [保存]        │
└──────────────────────────────────────────────┘
```

#### 5.4.6 脚本编辑器

**布局**（请求头脚本配置）：
```
┌────────────────────────────────────────────────────────────┐
│  编辑请求头: X-Request-Signature                    [X]     │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  Header 名称 *                                              │
│  [X-Request-Signature____________]                          │
│                                                             │
│  值类型   ◯ 静态值  ◉ JavaScript  ◯ Python                 │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 脚本编辑器                     [从模板选择 ▼] [格式化] │ │
│  ├───────────────────────────────────────────────────────┤ │
│  │ 1  // 可用上下文变量:                                 │ │
│  │ 2  // - context.timestamp                             │ │
│  │ 3  // - context.apiKey                                │ │
│  │ 4  // - context.request.method                        │ │
│  │ 5  // - context.request.path                          │ │
│  │ 6                                                     │ │
│  │ 7  const crypto = require('crypto');                  │ │
│  │ 8                                                     │ │
│  │ 9  const data = context.request.body +                │ │
│  │10              context.timestamp;                     │ │
│  │11                                                     │ │
│  │12  const signature = crypto                           │ │
│  │13    .createHmac('sha256', context.apiKey)            │ │
│  │14    .update(data)                                    │ │
│  │15    .digest('hex');                                  │ │
│  │16                                                     │ │
│  │17  return signature;                                  │ │
│  │                                                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  测试脚本                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 模拟请求数据 (JSON)                                    │ │
│  │ {                                                     │ │
│  │   "method": "POST",                                   │ │
│  │   "path": "/v1/chat/completions",                     │ │
│  │   "body": "{\"model\":\"gpt-4\"}"                     │ │
│  │ }                                                     │ │
│  │                                      [执行测试]        │ │
│  ├───────────────────────────────────────────────────────┤ │
│  │ ✅ 执行成功 (耗时: 2ms)                                │ │
│  │ 生成结果: a3f8b9c...                                   │ │
│  │                                                       │ │
│  │ Console 输出:                                         │ │
│  │ (无输出)                                              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  高级选项                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 执行超时: [1000] 毫秒                                  │ │
│  │ 失败策略: [使用默认值 ▼]                               │ │
│  │ 默认值:  [_______________]                             │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│                            [取消]  [保存]                   │
└────────────────────────────────────────────────────────────┘
```

### 5.5 交互规范

#### 5.5.1 通用组件

**按钮**
- 主要操作：蓝色填充按钮（Primary）
- 次要操作：灰色边框按钮（Secondary）
- 危险操作：红色按钮（Danger）
- 文本按钮：无边框，用于次要链接

**表单输入**
- 必填字段标注 `*`
- 实时验证，错误提示显示在输入框下方
- 长文本使用 Textarea，支持自动高度

**Toast 提示**
- 成功：绿色，3秒自动消失
- 错误：红色，5秒自动消失或手动关闭
- 警告：黄色，5秒自动消失
- 信息：蓝色，3秒自动消失

**确认对话框**
- 危险操作（删除、禁用）必须二次确认
- 显示操作影响范围（如：将删除 3 个关联规则）

#### 5.5.2 状态标识

```
✅ 活跃/正常    - 绿色
🔴 禁用/错误    - 红色
⚠️  警告        - 黄色
⚫ 已停用       - 灰色
🔵 处理中       - 蓝色
```

#### 5.5.3 加载状态

- **列表加载**：骨架屏（Skeleton）
- **操作加载**：按钮显示 Spinner + 禁用
- **页面切换**：顶部进度条

---

## 六、开发计划

### 6.1 里程碑

| 阶段 | 时间 | 交付内容 | 优先级 |
|------|------|----------|--------|
| **Phase 1: MVP** | Week 1-4 | 核心功能实现 | P0 |
| **Phase 2: 完善** | Week 5-6 | 增强功能与优化 | P1 |
| **Phase 3: 扩展** | Week 7-8 | 高级功能与企业特性 | P2 |

### 6.2 详细任务分解

#### Phase 1: MVP (Week 1-4)

**Week 1: 基础架构**
- [ ] 项目初始化（Next.js + FastAPI）
- [ ] 数据库设计与迁移脚本
- [ ] 基础 API 框架搭建
- [ ] 前端基础组件库（shadcn/ui）
- [ ] 路由与布局设计

**Week 2: 核心功能 - 后端**
- [ ] 上游 API CRUD 接口
- [ ] 密钥管理接口（CRUD + 选择逻辑）
- [ ] 代理转发核心逻辑
- [ ] 请求日志记录
- [ ] 基础规则引擎（状态码判断）

**Week 3: 核心功能 - 前端**
- [ ] 上游 API 管理页面
- [ ] 密钥管理页面
- [ ] 密钥测试功能
- [ ] 简易仪表板（关键指标）

**Week 4: 规则与集成**
- [ ] 失效规则配置页面
- [ ] 规则引擎完善（Body 判断、逻辑运算）
- [ ] 自动禁用/启用逻辑
- [ ] 定时任务调度
- [ ] 基础测试与Bug修复

#### Phase 2: 完善 (Week 5-6)

**Week 5: 高级功能**
- [ ] 请求头动态配置
- [ ] JavaScript 脚本执行
- [ ] 请求日志查询页面
- [ ] 日志详情与统计
- [ ] 频率限制规则

**Week 6: 用户体验优化**
- [ ] 仪表板实时数据
- [ ] 图表优化（Recharts）
- [ ] 批量导入/导出
- [ ] 通知系统（邮件/Webhook）
- [ ] 性能优化与压测

#### Phase 3: 扩展 (Week 7-8)

**Week 7: 企业特性**
- [ ] Python 脚本执行
- [ ] 用户权限系统
- [ ] 操作审计日志
- [ ] API Token 管理
- [ ] 数据备份与恢复

**Week 8: 部署与文档**
- [ ] Docker 容器化
- [ ] 部署文档编写
- [ ] 用户使用手册
- [ ] API 接口文档 

### 6.3 技术风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 脚本执行安全隐患 | 高 | 中 | 使用沙箱隔离、资源限制 |
| 高并发性能瓶颈 | 中 | 中 | 异步处理、连接池优化 |
| 规则引擎复杂度 | 中 | 高 | 简化 MVP，逐步迭代 |
| SQLite 扩展性问题 | 低 | 低 | 预留数据库切换接口 |

---

## 七、运维与监控

### 7.1 日志规范

**日志级别**
- DEBUG：调试信息（开发环境）
- INFO：正常操作（请求处理、密钥切换）
- WARNING：可恢复错误（重试成功）
- ERROR：需要关注的错误
- CRITICAL：系统故障

**日志格式**（JSON）
```json
{
  "timestamp": "2025-11-02T14:23:45.123Z",
  "level": "ERROR",
  "module": "proxy.forward",
  "message": "API request failed",
  "context": {
    "upstream_id": 1,
    "key_id": 5,
    "status_code": 500,
    "latency_ms": 1234
  }
}
```

### 7.2 监控指标

**系统指标**
- CPU、内存、磁盘使用率
- 进程存活状态

**业务指标**
- QPS（每秒请求数）
- 请求成功率
- P50/P95/P99 延迟
- 密钥健康率

**告警规则**
- 成功率 < 95%
- P95 延迟 > 500ms
- 活跃密钥 < 5 个
- 磁盘使用 > 80%
